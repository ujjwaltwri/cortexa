<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORTEXA | Autonomous Financial Intelligence</title>
    
    <!-- Fonts: Inter for UI, JetBrains Mono for Data -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        bg: '#030712',      // Ultra-dark blue/black
                        surface: '#0F172A', // Slate-900
                        border: '#1E293B',  // Slate-800
                        primary: '#06B6D4', // Cyan-500
                        accent: '#8B5CF6',  // Violet-500
                        success: '#10B981', // Emerald-500
                        danger: '#F43F5E',  // Rose-500
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #030712; color: #E2E8F0; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-panel {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4) 0%, rgba(15, 23, 42, 0.6) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* Cyberpunk Glows */
        .glow-text { text-shadow: 0 0 10px rgba(6, 182, 212, 0.5); }
        .glow-border { box-shadow: 0 0 15px -3px rgba(6, 182, 212, 0.1); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased selection:bg-cyan-500/30 selection:text-cyan-200">

    <!-- Ambient Background -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-0 left-0 w-full h-96 bg-gradient-to-b from-cyan-900/10 to-transparent opacity-40"></div>
        <div class="absolute bottom-0 right-0 w-[500px] h-[500px] bg-purple-900/10 rounded-full blur-[128px]"></div>
    </div>

    <!-- Header -->
    <header class="fixed w-full top-0 z-50 glass border-b border-white/5">
        <div class="max-w-3xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <!-- Animated Status Dot -->
                <div class="relative flex h-2.5 w-2.5">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-cyan-500"></span>
                </div>
                <h1 class="font-bold text-lg tracking-widest text-slate-100 font-mono">
                    CORTEXA <span class="text-cyan-500 text-xs opacity-70">v3.0</span>
                </h1>
            </div>
            <div class="text-[10px] font-mono text-slate-500 tracking-tight">
                SYSTEM ONLINE // REGIME AWARE
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow relative z-10 pt-24 pb-32 px-4">
        <div class="max-w-3xl mx-auto">
            
            <!-- Chat History -->
            <div id="chat-container" class="space-y-8">
                
                <!-- Intro Message -->
                <div class="flex gap-4 animate-fade-in-up">
                    <div class="w-8 h-8 rounded-lg bg-slate-800/80 border border-white/10 flex items-center justify-center flex-shrink-0 shadow-lg">
                        <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    </div>
                    <div class="glass-panel p-5 rounded-2xl rounded-tl-none max-w-[90%]">
                        <p class="text-sm text-slate-300 leading-relaxed">
                            Systems initialized. I am Cortexa. I combine quantitative models with historical context to generate trading signals.
                            <br><br>
                            Ask me about a ticker (e.g., <span class="text-cyan-400 font-mono">AAPL</span>, <span class="text-cyan-400 font-mono">NVDA</span>) to begin analysis.
                        </p>
                    </div>
                </div>

            </div>
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden flex gap-4 mt-6 animate-pulse">
                <div class="w-8 h-8 rounded-lg bg-slate-800/50 flex items-center justify-center">ðŸ¤–</div>
                <div class="flex items-center space-x-1.5 h-8">
                    <div class="w-1.5 h-1.5 bg-cyan-500 rounded-full animate-bounce"></div>
                    <div class="w-1.5 h-1.5 bg-cyan-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-1.5 h-1.5 bg-cyan-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
            </div>

        </div>
    </main>

    <!-- Signal Card Template (Hidden) -->
    <template id="signal-card-template">
        <div class="mt-6 w-full animate-fade-in-up">
            <div class="glass-panel rounded-xl overflow-hidden glow-border">
                
                <!-- Header -->
                <div class="px-6 py-3 border-b border-white/5 bg-white/5 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span class="signal-ticker font-mono text-xl font-bold text-white tracking-widest">---</span>
                        <span class="signal-regime px-2 py-0.5 rounded text-[10px] font-mono uppercase bg-slate-700/50 text-slate-300 border border-white/5">Regime Scan</span>
                    </div>
                    <div class="font-mono text-xs text-slate-400">SCORE: <span class="signal-score text-cyan-400 font-bold">--%</span></div>
                </div>

                <div class="p-6">
                    <!-- Big Decision -->
                    <div class="text-center mb-8">
                        <div class="signal-decision text-4xl font-bold tracking-tight drop-shadow-2xl">---</div>
                    </div>

                    <!-- Trade Plan Grid -->
                    <div class="grid grid-cols-3 gap-3 mb-8 font-mono text-xs">
                        <div class="bg-slate-800/30 rounded p-2 text-center border border-red-500/20">
                            <div class="text-red-400/70 mb-1">STOP</div>
                            <div class="signal-stop text-slate-200 font-bold">---</div>
                        </div>
                        <div class="bg-slate-800/30 rounded p-2 text-center border border-slate-500/20">
                            <div class="text-slate-400/70 mb-1">PRICE</div>
                            <div class="signal-price text-slate-200 font-bold">---</div>
                        </div>
                        <div class="bg-slate-800/30 rounded p-2 text-center border border-success/20">
                            <div class="text-emerald-400/70 mb-1">TARGET</div>
                            <div class="signal-target text-slate-200 font-bold">---</div>
                        </div>
                    </div>

                    <!-- Probability Bars -->
                    <div class="space-y-4">
                        <!-- ML -->
                        <div class="group">
                            <div class="flex justify-between text-[10px] uppercase tracking-wider text-slate-500 mb-1">
                                <span>Quant Model</span>
                                <span class="signal-ml-val group-hover:text-blue-400 transition-colors">--%</span>
                            </div>
                            <div class="h-1 w-full bg-slate-800 rounded-full overflow-hidden">
                                <div class="signal-ml-bar h-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)] transition-all duration-1000 ease-out" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- RAG -->
                        <div class="group">
                            <div class="flex justify-between text-[10px] uppercase tracking-wider text-slate-500 mb-1">
                                <span>Historical Context</span>
                                <span class="signal-rag-val group-hover:text-purple-400 transition-colors">--%</span>
                            </div>
                            <div class="h-1 w-full bg-slate-800 rounded-full overflow-hidden">
                                <div class="signal-rag-bar h-full bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.5)] transition-all duration-1000 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Context -->
                    <div class="mt-6 pt-4 border-t border-white/5 flex gap-2 items-start">
                        <svg class="w-3 h-3 text-slate-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="signal-context text-xs text-slate-500 leading-snug font-mono">Loading context...</p>
                    </div>

                </div>
            </div>
        </div>
    </template>

    <!-- Fixed Input Area -->
    <div class="fixed bottom-0 w-full bg-gradient-to-t from-[#030712] via-[#030712] to-transparent pt-10 pb-6 z-40">
        <div class="max-w-3xl mx-auto px-4">
            <form id="query-form" class="relative">
                <div class="absolute inset-0 bg-gradient-to-r from-cyan-500/20 to-purple-500/20 rounded-full blur-xl opacity-0 transition-opacity duration-500 group-hover:opacity-100"></div>
                <input 
                    type="text" 
                    id="user-query" 
                    class="w-full bg-[#0F172A]/90 border border-white/10 text-slate-200 text-sm rounded-full pl-6 pr-14 py-4 focus:outline-none focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/50 focus:bg-[#162032] transition-all placeholder-slate-600 shadow-lg backdrop-blur-md font-mono"
                    placeholder="Enter ticker command..."
                    autocomplete="off"
                >
                <button type="submit" class="absolute right-2 top-2 p-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-full transition-all shadow-lg group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover:translate-x-0.5 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = "http://127.0.0.1:8000";
        const TICKER_LOOKUP = {
            "AAPL": "AAPL", "APPLE": "AAPL", "MSFT": "MSFT", "MICROSOFT": "MSFT",
            "GOOGL": "GOOGL", "GOOGLE": "GOOGL", "NVDA": "NVDA", "TSLA": "TSLA",
            "AMD": "AMD", "META": "META", "AMZN": "AMZN"
        };

        const form = document.getElementById('query-form');
        const input = document.getElementById('user-query');
        const chat = document.getElementById('chat-container');
        const loader = document.getElementById('loading-indicator');
        const tpl = document.getElementById('signal-card-template');

        function detectTicker(q) {
            const clean = q.toUpperCase();
            for (const k in TICKER_LOOKUP) {
                if (new RegExp(`\\b${k}\\b`, 'i').test(clean)) return TICKER_LOOKUP[k];
            }
            return null;
        }

        function addMessage(html, isUser = false) {
            const div = document.createElement('div');
            div.className = `flex gap-4 animate-fade-in-up ${isUser ? 'justify-end' : ''}`;
            
            const bubbleClass = isUser ? 'bg-cyan-950/50 border-cyan-500/30 text-cyan-100' : 'glass-panel text-slate-300';
            
            div.innerHTML = isUser ? 
                `<div class="${bubbleClass} border p-4 rounded-2xl rounded-tr-none max-w-[85%] text-sm font-medium">${html}</div>` :
                `<div class="w-8 h-8 rounded-lg bg-slate-800 border border-white/10 flex items-center justify-center flex-shrink-0">ðŸ¤–</div>
                 <div class="${bubbleClass} p-5 rounded-2xl rounded-tl-none max-w-[90%] text-sm leading-relaxed shadow-lg">${html}</div>`;
            
            chat.appendChild(div);
            window.scrollTo(0, document.body.scrollHeight);
        }

        function renderSignal(ticker, data) {
            const clone = tpl.content.cloneNode(true);
            const root = clone.querySelector('div');
            
            // 1. Header
            root.querySelector('.signal-ticker').textContent = ticker;
            root.querySelector('.signal-score').textContent = data.combined_score;
            
            // 2. Decision Color
            const decEl = root.querySelector('.signal-decision');
            decEl.textContent = data.signal;
            if (data.signal.includes("BUY")) decEl.classList.add("text-emerald-400", "glow-text");
            else if (data.signal.includes("SELL")) decEl.classList.add("text-rose-400", "glow-text");
            else decEl.classList.add("text-amber-400"); // Hold

            // 3. Risk Grid
            if (data.risk) {
                root.querySelector('.signal-stop').textContent = data.risk.stop_loss;
                root.querySelector('.signal-price').textContent = data.risk.current_price;
                root.querySelector('.signal-target').textContent = data.risk.take_profit;
            }

            // 4. Context
            const reg = data.filter_used?.regime || '?';
            root.querySelector('.signal-regime').textContent = `REGIME ${reg}`;
            root.querySelector('.signal-context').textContent = `${data.rag_contexts_found} historical matches found in Regime ${reg}.`;
            
            // 5. Bars
            root.querySelector('.signal-ml-val').textContent = data.ml_probability;
            root.querySelector('.signal-rag-val').textContent = data.rag_probability;
            
            // Append first, then animate width
            chat.appendChild(clone);
            
            // Trigger CSS transition
            setTimeout(() => {
                const bars = chat.querySelectorAll('.signal-ml-bar, .signal-rag-bar');
                // Only animate the last added ones
                const lastMl = bars[bars.length-2];
                const lastRag = bars[bars.length-1];
                lastMl.style.width = `${parseFloat(data.ml_probability)}%`;
                lastRag.style.width = `${parseFloat(data.rag_probability)}%`;
            }, 50);

            window.scrollTo(0, document.body.scrollHeight);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const q = input.value.trim();
            if (!q) return;
            
            addMessage(q, true);
            input.value = '';
            input.blur();
            loader.classList.remove('hidden');

            try {
                const ticker = detectTicker(q);
                
                // Parallel Request
                const tasks = [
                    fetch(`${API_BASE_URL}/query`, {
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ text: q })
                    }).then(r => r.json())
                ];

                if (ticker) {
                    tasks.push(fetch(`${API_BASE_URL}/predict/${ticker}`).then(r => r.json()).catch(() => null));
                }

                const [rag, signal] = await Promise.all(tasks);
                loader.classList.add('hidden');

                // Render Text
                if (rag.answer) {
                    let text = rag.answer
                        .replace(/\*\*(.*?)\*\*/g, '<span class="text-cyan-300 font-semibold">$1</span>')
                        .replace(/- /g, 'â€¢ ')
                        .replace(/\n/g, '<br>');
                    
                    if (rag.sources && rag.sources.length) {
                        text += `<div class="mt-4 pt-3 border-t border-white/10 grid gap-1">`;
                        rag.sources.forEach(s => {
                            text += `<a href="${s.link}" target="_blank" class="block text-xs text-slate-500 hover:text-cyan-400 truncate transition-colors">â†— ${s.title}</a>`;
                        });
                        text += `</div>`;
                    }
                    addMessage(text);
                }

                // Render Signal
                if (signal && signal.signal !== "No Data") {
                    renderSignal(ticker, signal);
                } else if (signal && signal.signal === "No Data") {
                    addMessage(`Could not generate signal for ${ticker}: ${signal.detail}`);
                }

            } catch (err) {
                loader.classList.add('hidden');
                addMessage(`<span class="text-rose-400">System Error: ${err.message}</span>`);
            }
        });
    </script>
</body>
</html>